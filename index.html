<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Workout Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0a0a0b;
  --surface: #141416;
  --surface2: #1c1c20;
  --surface3: #24242a;
  --border: #2a2a32;
  --text: #e8e8ed;
  --text2: #9898a4;
  --text3: #5c5c6a;
  --accent: #4ade80;
  --accent2: #22c55e;
  --warn: #fbbf24;
  --danger: #f87171;
  --blue: #60a5fa;
  --purple: #a78bfa;
  --radius: 12px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

html, body {
  font-family: 'Outfit', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(10, 10, 11, 0.92);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 12px 16px;
}

.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.header-title { font-size: 15px; font-weight: 600; letter-spacing: -0.3px; }
.header-week { font-size: 12px; color: var(--text2); font-family: 'JetBrains Mono', monospace; }
.header-actions { display: flex; gap: 8px; }

.header-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text2);
  font-size: 12px;
  font-family: 'Outfit', sans-serif;
  font-weight: 500;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
}
.header-btn:active { background: var(--surface3); }
.header-btn.primary { background: var(--accent2); color: #000; border-color: var(--accent2); font-weight: 600; }

.version { font-size: 9px; color: var(--text3); font-family: 'JetBrains Mono', monospace; }

.day-tabs-wrapper { padding-top: 6px; }

.day-tabs {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
  -webkit-overflow-scrolling: touch;
}
.day-tabs::-webkit-scrollbar { display: none; }

.day-tab {
  flex-shrink: 0;
  background: var(--surface2);
  border: 2px solid var(--border);
  color: var(--text2);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  padding: 12px 18px;
  border-radius: 10px;
  cursor: pointer;
  position: relative;
  min-height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}

.day-tab.active {
  color: var(--accent);
  background: rgba(74, 222, 128, 0.12);
  border-color: var(--accent);
}

.day-tab.has-data::after {
  content: '';
  position: absolute;
  bottom: 4px;
  left: 50%;
  transform: translateX(-50%);
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background: var(--accent);
}

.workout-container {
  padding: 16px;
  padding-bottom: calc(90px + var(--safe-bottom));
}

.day-header { margin-bottom: 20px; }
.day-header h2 { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 4px; }
.day-header .day-meta { font-size: 12px; color: var(--text2); font-family: 'JetBrains Mono', monospace; }

.exercise-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 12px;
  overflow: hidden;
}
.exercise-card.complete { border-color: rgba(74, 222, 128, 0.3); }
.exercise-card.partial { border-color: rgba(251, 191, 36, 0.3); }

.exercise-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 14px 14px 10px;
  cursor: pointer;
}

.exercise-name { font-size: 15px; font-weight: 600; letter-spacing: -0.3px; flex: 1; }

.exercise-status {
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  padding: 3px 8px;
  border-radius: 6px;
  flex-shrink: 0;
  margin-left: 8px;
}
.exercise-status.pending { background: var(--surface3); color: var(--text3); }
.exercise-status.complete { background: rgba(74, 222, 128, 0.15); color: var(--accent); }
.exercise-status.partial { background: rgba(251, 191, 36, 0.15); color: var(--warn); }

.exercise-note {
  font-size: 12px;
  color: var(--text3);
  padding: 0 14px 10px;
  line-height: 1.5;
  display: none;
}
.exercise-card.expanded .exercise-note { display: block; }

.sets-container { padding: 0 14px 14px; }

.set-row {
  display: grid;
  grid-template-columns: 32px 1fr 1fr 40px;
  gap: 8px;
  align-items: center;
  padding: 8px 0;
  border-top: 1px solid var(--border);
}
.set-row:first-child { border-top: none; }

.set-label { font-size: 11px; font-family: 'JetBrains Mono', monospace; color: var(--text3); font-weight: 600; }
.set-prescribed { font-size: 12px; color: var(--text2); font-family: 'JetBrains Mono', monospace; }
.set-actual { display: flex; gap: 4px; }

.set-input {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 14px;
  font-weight: 600;
  width: 100%;
  padding: 8px 6px;
  border-radius: 8px;
  text-align: center;
  outline: none;
  -webkit-appearance: none;
}
.set-input:focus { border-color: var(--accent); }
.set-input.over { border-color: var(--accent); background: rgba(74, 222, 128, 0.08); }
.set-input.under { border-color: var(--warn); background: rgba(251, 191, 36, 0.08); }
.set-input.miss { border-color: var(--danger); background: rgba(248, 113, 113, 0.08); }

.set-check {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  background: transparent;
  color: var(--text3);
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.set-check.done { background: var(--accent2); border-color: var(--accent2); color: #000; }

.input-group { display: flex; flex-direction: column; gap: 2px; }
.input-label { font-size: 9px; color: var(--text3); font-family: 'JetBrains Mono', monospace; text-transform: uppercase; letter-spacing: 0.5px; text-align: center; }

.rpe-row { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-top: 1px solid var(--border); }
.rpe-label { font-size: 11px; color: var(--text3); font-family: 'JetBrains Mono', monospace; font-weight: 600; flex-shrink: 0; }
.rpe-buttons { display: flex; gap: 4px; }
.rpe-btn {
  width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--border);
  background: var(--surface2); color: var(--text3); font-family: 'JetBrains Mono', monospace;
  font-size: 12px; font-weight: 600; cursor: pointer;
}
.rpe-btn.selected { border-color: var(--blue); background: rgba(96, 165, 250, 0.15); color: var(--blue); }

.sub-row { display: flex; align-items: center; gap: 8px; padding: 0 14px 10px; }
.sub-label { font-size: 11px; color: var(--text3); font-family: 'JetBrains Mono', monospace; }
.sub-input {
  flex: 1; background: var(--surface2); border: 1px solid var(--border); color: var(--text);
  font-family: 'Outfit', sans-serif; font-size: 13px; padding: 6px 10px; border-radius: 8px; outline: none;
}
.sub-input:focus { border-color: var(--purple); }
.sub-input::placeholder { color: var(--text3); }

.exercise-note-input {
  width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text);
  font-family: 'Outfit', sans-serif; font-size: 13px; padding: 8px 10px; border-radius: 8px;
  outline: none; margin-top: 8px; resize: none;
}
.exercise-note-input:focus { border-color: var(--blue); }
.exercise-note-input::placeholder { color: var(--text3); }

.summary-bar {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(20, 20, 22, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border); padding: 12px 16px;
  padding-bottom: calc(12px + var(--safe-bottom));
  display: none; justify-content: space-between; align-items: center; z-index: 100;
}

.summary-stats { display: flex; gap: 16px; }
.summary-stat { text-align: center; }
.summary-stat-value { font-family: 'JetBrains Mono', monospace; font-size: 16px; font-weight: 700; color: var(--accent); }
.summary-stat-label { font-size: 9px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }

.finish-btn {
  background: var(--accent2); color: #000; border: none; font-family: 'Outfit', sans-serif;
  font-size: 14px; font-weight: 600; padding: 10px 20px; border-radius: 10px; cursor: pointer;
}

.modal-overlay {
  position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 200;
  display: none; align-items: flex-end; justify-content: center;
}
.modal-overlay.show { display: flex; }

.modal {
  background: var(--surface); border-radius: 20px 20px 0 0; padding: 24px 20px;
  padding-bottom: calc(24px + var(--safe-bottom)); width: 100%; max-width: 500px;
  max-height: 80vh; overflow-y: auto; animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.modal h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
.modal-actions { display: flex; gap: 8px; margin-top: 16px; }
.modal-btn {
  flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
  background: var(--surface2); color: var(--text); font-family: 'Outfit', sans-serif;
  font-size: 14px; font-weight: 500; cursor: pointer;
}

.file-input { display: none; }

.import-zone {
  border: 2px dashed var(--border); border-radius: var(--radius); padding: 32px;
  text-align: center; cursor: pointer; margin-bottom: 12px;
}
.import-zone:active { border-color: var(--accent); }
.import-zone-icon { font-size: 32px; margin-bottom: 8px; }
.import-zone-text { font-size: 14px; color: var(--text2); }

.empty-state { text-align: center; padding: 60px 20px; }
.empty-state-icon { font-size: 48px; margin-bottom: 16px; }
.empty-state h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
.empty-state p { font-size: 14px; color: var(--text2); line-height: 1.6; }

.rest-timer {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  background: var(--surface); border: 2px solid var(--accent); border-radius: 20px;
  padding: 32px; text-align: center; z-index: 300; display: none;
  box-shadow: 0 0 60px rgba(74, 222, 128, 0.2); min-width: 220px;
}
.rest-timer.show { display: block; }
.rest-timer-time { font-family: 'JetBrains Mono', monospace; font-size: 48px; font-weight: 700; color: var(--accent); margin-bottom: 8px; }
.rest-timer-label { font-size: 13px; color: var(--text2); margin-bottom: 16px; }
.rest-timer-btn {
  background: var(--surface3); border: 1px solid var(--border); color: var(--text2);
  font-family: 'Outfit', sans-serif; font-size: 13px; padding: 8px 20px; border-radius: 8px; cursor: pointer;
}

.rest-timer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 299; display: none; }
.rest-timer-overlay.show { display: block; }

@media (min-width: 500px) {
  .workout-container { max-width: 500px; margin: 0 auto; }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <div>
      <div class="header-title" id="planTitle">Workout Tracker</div>
      <div class="header-week" id="planWeek">No plan loaded</div>
      <div class="version">v3</div>
    </div>
    <div class="header-actions">
      <button class="header-btn" id="btnImport">Import</button>
      <button class="header-btn primary" id="btnExport">Export</button>
    </div>
  </div>
  <div class="day-tabs-wrapper">
    <div class="day-tabs" id="dayTabs"></div>
  </div>
</div>

<div class="workout-container" id="workoutContainer">
  <div class="empty-state" id="emptyState">
    <div class="empty-state-icon">üèãÔ∏è</div>
    <h3>No Plan Loaded</h3>
    <p>Tap <strong>Import</strong> to load your weekly plan JSON, then start tracking.</p>
  </div>
</div>

<div class="summary-bar" id="summaryBar">
  <div class="summary-stats">
    <div class="summary-stat">
      <div class="summary-stat-value" id="setsComplete">0</div>
      <div class="summary-stat-label">Sets Done</div>
    </div>
    <div class="summary-stat">
      <div class="summary-stat-value" id="setsTotal">0</div>
      <div class="summary-stat-label">Total Sets</div>
    </div>
    <div class="summary-stat">
      <div class="summary-stat-value" id="dayProgress">0%</div>
      <div class="summary-stat-label">Complete</div>
    </div>
  </div>
  <button class="finish-btn" id="btnRest">Rest Timer</button>
</div>

<div class="modal-overlay" id="importModal">
  <div class="modal">
    <h3>Import Plan</h3>
    <div class="import-zone" id="importZone">
      <div class="import-zone-icon">üìã</div>
      <div class="import-zone-text">Tap to select your plan JSON file</div>
    </div>
    <input type="file" id="fileInput" class="file-input" accept=".json">
    <div class="modal-actions">
      <button class="modal-btn" id="btnCancelImport">Cancel</button>
    </div>
  </div>
</div>

<div class="rest-timer-overlay" id="restOverlay"></div>
<div class="rest-timer" id="restTimer">
  <div class="rest-timer-time" id="restTime">0:00</div>
  <div class="rest-timer-label">Rest Period</div>
  <button class="rest-timer-btn" id="btnStopRest">Skip</button>
</div>

<script>
var plan = null;
var logData = {};
var currentDay = 0;
var restInterval = null;
var restSeconds = 0;

// ALL EVENT LISTENERS
document.getElementById('btnImport').addEventListener('click', function() {
  document.getElementById('importModal').classList.add('show');
});
document.getElementById('btnExport').addEventListener('click', exportData);
document.getElementById('importZone').addEventListener('click', function() {
  document.getElementById('fileInput').click();
});
document.getElementById('fileInput').addEventListener('change', handleImport);
document.getElementById('btnCancelImport').addEventListener('click', function() {
  document.getElementById('importModal').classList.remove('show');
});
document.getElementById('importModal').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('show');
});
document.getElementById('btnRest').addEventListener('click', function() { startRestTimer(90); });
document.getElementById('btnStopRest').addEventListener('click', stopRestTimer);
document.getElementById('restOverlay').addEventListener('click', stopRestTimer);

// TAB CLICKS
document.getElementById('dayTabs').addEventListener('click', function(e) {
  var tab = e.target;
  while (tab && tab !== this && !tab.classList.contains('day-tab')) {
    tab = tab.parentElement;
  }
  if (!tab || !tab.classList.contains('day-tab')) return;
  var idx = tab.getAttribute('data-day');
  if (idx === null) return;
  currentDay = parseInt(idx, 10);
  buildTabs();
  buildDay(currentDay);
});

// WORKOUT CONTAINER clicks
document.getElementById('workoutContainer').addEventListener('click', function(e) {
  var target = e.target;
  // Expand card
  var header = target.closest ? target.closest('.exercise-header') : null;
  if (header) {
    var card = header.parentElement;
    if (card) card.classList.toggle('expanded');
    return;
  }
  // Set check
  var checkBtn = target.closest ? target.closest('.set-check') : null;
  if (checkBtn) {
    toggleSet(
      parseInt(checkBtn.getAttribute('data-di')),
      parseInt(checkBtn.getAttribute('data-ei')),
      parseInt(checkBtn.getAttribute('data-si'))
    );
    return;
  }
  // RPE
  var rpeBtn = target.closest ? target.closest('.rpe-btn') : null;
  if (rpeBtn) {
    logRPE(
      parseInt(rpeBtn.getAttribute('data-di')),
      parseInt(rpeBtn.getAttribute('data-ei')),
      parseInt(rpeBtn.getAttribute('data-rpe'))
    );
    return;
  }
});

// WORKOUT CONTAINER input changes
document.getElementById('workoutContainer').addEventListener('change', function(e) {
  var t = e.target;
  if (t.classList.contains('set-input')) {
    logSet(parseInt(t.getAttribute('data-di')), parseInt(t.getAttribute('data-ei')),
      parseInt(t.getAttribute('data-si')), t.getAttribute('data-field'), t.value);
  }
  if (t.classList.contains('sub-input')) {
    logSub(parseInt(t.getAttribute('data-di')), parseInt(t.getAttribute('data-ei')), t.value);
  }
  if (t.classList.contains('exercise-note-input')) {
    logNote(parseInt(t.getAttribute('data-di')), parseInt(t.getAttribute('data-ei')), t.value);
  }
});

function init() {
  try {
    var saved = localStorage.getItem('workoutPlan');
    var savedLog = localStorage.getItem('workoutLog');
    if (saved) {
      plan = JSON.parse(saved);
      if (savedLog) logData = JSON.parse(savedLog);
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('summaryBar').style.display = 'flex';
      document.getElementById('planTitle').textContent = plan.title || 'Workout Tracker';
      document.getElementById('planWeek').textContent = plan.week || '';
      buildTabs();
      buildDay(currentDay);
    }
  } catch(err) {
    console.error('Init error:', err);
  }
}

function buildTabs() {
  var el = document.getElementById('dayTabs');
  var h = '';
  for (var i = 0; i < plan.days.length; i++) {
    var d = plan.days[i];
    var cls = 'day-tab';
    if (i === currentDay) cls += ' active';
    if (logData['day_' + i] && Object.keys(logData['day_' + i].exercises || {}).length > 0) cls += ' has-data';
    h += '<button class="' + cls + '" data-day="' + i + '">' + (d.short || 'D' + (i+1)) + '</button>';
  }
  el.innerHTML = h;
}

function buildDay(di) {
  var day = plan.days[di];
  var c = document.getElementById('workoutContainer');
  if (!logData['day_' + di]) logData['day_' + di] = { exercises: {}, date: null };

  var ts = 0, cs = 0;
  var h = '<div class="day-header"><h2>' + day.name + '</h2><div class="day-meta">' + (day.sets_total || '') + ' ¬∑ ' + (day.duration || '') + '</div></div>';

  for (var ei = 0; ei < day.exercises.length; ei++) {
    var ex = day.exercises[ei];
    var ek = 'ex_' + ei;
    var el = logData['day_' + di].exercises[ek] || { sets: [], rpe: null, note: '', sub: '' };
    ts += ex.sets.length;
    var dn = 0;
    for (var s = 0; s < el.sets.length; s++) { if (el.sets[s] && el.sets[s].done) dn++; }
    cs += dn;
    var ad = dn === ex.sets.length, sd = dn > 0 && !ad;
    var sc = ad ? 'complete' : sd ? 'partial' : 'pending';
    var st = ad ? dn + '/' + ex.sets.length + ' ‚úì' : dn + '/' + ex.sets.length;
    var cc = ad ? ' complete' : sd ? ' partial' : '';

    h += '<div class="exercise-card' + cc + '">';
    h += '<div class="exercise-header"><div class="exercise-name">' + ex.name + '</div><div class="exercise-status ' + sc + '">' + st + '</div></div>';
    if (ex.note) h += '<div class="exercise-note">' + ex.note + '</div>';
    h += '<div class="sets-container">';

    for (var si = 0; si < ex.sets.length; si++) {
      var set = ex.sets[si];
      var sl = el.sets[si] || {};
      var pr = fmtP(set);
      var wc = inputCls(sl.weight, set.weight);
      var rc = inputCls(sl.reps, set.reps_target);

      h += '<div class="set-row">';
      h += '<div class="set-label">S' + (si+1) + '</div>';
      h += '<div class="set-prescribed">' + pr + '</div>';
      h += '<div class="set-actual">';
      h += '<div class="input-group"><label class="input-label">LBS</label>';
      h += '<input type="number" inputmode="decimal" class="set-input ' + wc + '" value="' + (sl.weight || '') + '" placeholder="' + (set.weight || '‚Äî') + '" data-di="' + di + '" data-ei="' + ei + '" data-si="' + si + '" data-field="weight" onfocus="this.select()"></div>';
      h += '<div class="input-group"><label class="input-label">REPS</label>';
      h += '<input type="number" inputmode="numeric" class="set-input ' + rc + '" value="' + (sl.reps || '') + '" placeholder="' + (set.reps_target || '‚Äî') + '" data-di="' + di + '" data-ei="' + ei + '" data-si="' + si + '" data-field="reps" onfocus="this.select()"></div>';
      h += '</div>';
      h += '<button class="set-check ' + (sl.done ? 'done' : '') + '" data-di="' + di + '" data-ei="' + ei + '" data-si="' + si + '">' + (sl.done ? '‚úì' : '¬∑') + '</button>';
      h += '</div>';
    }

    h += '<div class="rpe-row"><div class="rpe-label">RPE</div><div class="rpe-buttons">';
    var rv = [6,7,8,9,10];
    for (var r = 0; r < rv.length; r++) {
      h += '<button class="rpe-btn' + (el.rpe === rv[r] ? ' selected' : '') + '" data-di="' + di + '" data-ei="' + ei + '" data-rpe="' + rv[r] + '">' + rv[r] + '</button>';
    }
    h += '</div></div></div>';

    h += '<div class="sub-row"><div class="sub-label">SUB:</div><input type="text" class="sub-input" value="' + (el.sub || '') + '" placeholder="Substituted exercise" data-di="' + di + '" data-ei="' + ei + '"></div>';
    h += '<div style="padding:0 14px 14px"><textarea class="exercise-note-input" rows="1" placeholder="Notes" data-di="' + di + '" data-ei="' + ei + '">' + (el.note || '') + '</textarea></div>';
    h += '</div>';
  }

  c.innerHTML = h;
  document.getElementById('setsComplete').textContent = cs;
  document.getElementById('setsTotal').textContent = ts;
  document.getElementById('dayProgress').textContent = ts > 0 ? Math.round((cs / ts) * 100) + '%' : '0%';
}

function fmtP(s) {
  var p = [];
  if (s.weight) p.push(s.weight + (s.unit || 'lbs'));
  if (s.reps_target) p.push('x' + s.reps_target);
  if (s.reps_range) p.push('x' + s.reps_range);
  return p.join(' ') || '‚Äî';
}

function inputCls(a, t) {
  if (!a || !t) return '';
  a = parseFloat(a); t = parseFloat(t);
  if (isNaN(a) || isNaN(t)) return '';
  if (a >= t) return 'over';
  if (a >= t * 0.85) return 'under';
  return 'miss';
}

function logSet(di, ei, si, field, val) {
  var dk = 'day_' + di, ek = 'ex_' + ei;
  if (!logData[dk]) logData[dk] = { exercises: {}, date: new Date().toISOString() };
  if (!logData[dk].exercises[ek]) logData[dk].exercises[ek] = { sets: [], rpe: null, note: '', sub: '' };
  if (!logData[dk].exercises[ek].sets[si]) logData[dk].exercises[ek].sets[si] = {};
  logData[dk].exercises[ek].sets[si][field] = parseFloat(val) || null;
  logData[dk].date = new Date().toISOString();
  var sl = logData[dk].exercises[ek].sets[si];
  if (sl.weight && sl.reps) sl.done = true;
  saveLog();
  buildDay(di);
}

function toggleSet(di, ei, si) {
  var dk = 'day_' + di, ek = 'ex_' + ei;
  if (!logData[dk]) logData[dk] = { exercises: {}, date: new Date().toISOString() };
  if (!logData[dk].exercises[ek]) logData[dk].exercises[ek] = { sets: [], rpe: null, note: '', sub: '' };
  if (!logData[dk].exercises[ek].sets[si]) logData[dk].exercises[ek].sets[si] = {};
  logData[dk].exercises[ek].sets[si].done = !logData[dk].exercises[ek].sets[si].done;
  logData[dk].date = new Date().toISOString();
  saveLog();
  buildDay(di);
  if (logData[dk].exercises[ek].sets[si].done && plan.days[di] && plan.days[di].exercises[ei]) {
    startRestTimer(plan.days[di].exercises[ei].rest || 60);
  }
}

function logRPE(di, ei, rpe) {
  var dk = 'day_' + di, ek = 'ex_' + ei;
  if (!logData[dk]) logData[dk] = { exercises: {}, date: new Date().toISOString() };
  if (!logData[dk].exercises[ek]) logData[dk].exercises[ek] = { sets: [], rpe: null, note: '', sub: '' };
  logData[dk].exercises[ek].rpe = logData[dk].exercises[ek].rpe === rpe ? null : rpe;
  saveLog(); buildDay(di);
}

function logNote(di, ei, n) {
  var dk = 'day_' + di, ek = 'ex_' + ei;
  if (!logData[dk]) logData[dk] = { exercises: {}, date: new Date().toISOString() };
  if (!logData[dk].exercises[ek]) logData[dk].exercises[ek] = { sets: [], rpe: null, note: '', sub: '' };
  logData[dk].exercises[ek].note = n; saveLog();
}

function logSub(di, ei, s) {
  var dk = 'day_' + di, ek = 'ex_' + ei;
  if (!logData[dk]) logData[dk] = { exercises: {}, date: new Date().toISOString() };
  if (!logData[dk].exercises[ek]) logData[dk].exercises[ek] = { sets: [], rpe: null, note: '', sub: '' };
  logData[dk].exercises[ek].sub = s; saveLog();
}

function startRestTimer(sec) {
  if (typeof sec !== 'number' || sec <= 0) sec = 90;
  stopRestTimer(); restSeconds = sec;
  document.getElementById('restTimer').classList.add('show');
  document.getElementById('restOverlay').classList.add('show');
  updateRestDisplay();
  restInterval = setInterval(function() {
    restSeconds--;
    if (restSeconds <= 0) { stopRestTimer(); if (navigator.vibrate) navigator.vibrate([200,100,200]); }
    else updateRestDisplay();
  }, 1000);
}

function stopRestTimer() {
  clearInterval(restInterval); restInterval = null;
  document.getElementById('restTimer').classList.remove('show');
  document.getElementById('restOverlay').classList.remove('show');
}

function updateRestDisplay() {
  var m = Math.floor(restSeconds / 60), s = restSeconds % 60;
  document.getElementById('restTime').textContent = m + ':' + (s < 10 ? '0' : '') + s;
}

function saveLog() { localStorage.setItem('workoutLog', JSON.stringify(logData)); }

function handleImport(event) {
  var file = event.target.files[0]; if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      if (data.plan) plan = data.plan;
      else if (data.days) plan = data;
      else { alert('Invalid format'); return; }
      logData = {};
      localStorage.setItem('workoutPlan', JSON.stringify(plan));
      localStorage.setItem('workoutLog', '{}');
      currentDay = 0;
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('summaryBar').style.display = 'flex';
      document.getElementById('planTitle').textContent = plan.title || 'Workout Tracker';
      document.getElementById('planWeek').textContent = plan.week || '';
      buildTabs(); buildDay(0);
      document.getElementById('importModal').classList.remove('show');
    } catch(err) { alert('Error: ' + err.message); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function exportData() {
  if (!plan) { alert('No plan loaded'); return; }
  var obj = { plan_title: plan.title, plan_week: plan.week, exported_at: new Date().toISOString(),
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone, days: [] };
  for (var di = 0; di < plan.days.length; di++) {
    var day = plan.days[di];
    var dl = logData['day_' + di] || { exercises: {} };
    var d = { day_number: di+1, day_name: day.name, logged_date: dl.date || null, exercises: [] };
    for (var ei = 0; ei < day.exercises.length; ei++) {
      var ex = day.exercises[ei];
      var el = (dl.exercises || {})['ex_' + ei] || { sets: [], rpe: null, note: '', sub: '' };
      var x = { name: ex.name, substituted_with: el.sub || null, rpe: el.rpe, note: el.note || null, sets: [] };
      for (var si = 0; si < ex.sets.length; si++) {
        var set = ex.sets[si], sl = el.sets[si] || {};
        x.sets.push({ prescribed_weight: set.weight, prescribed_reps: set.reps_target || set.reps_range,
          prescribed_rest: set.rest, actual_weight: sl.weight || null, actual_reps: sl.reps || null,
          completed: sl.done || false, unit: set.unit || 'lbs' });
      }
      d.exercises.push(x);
    }
    obj.days.push(d);
  }
  var blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a'); a.href = url;
  a.download = 'workout-export-' + new Date().toISOString().slice(0,10) + '.json';
  a.click(); URL.revokeObjectURL(url);
}

init();
</script>
</body>
</html>
